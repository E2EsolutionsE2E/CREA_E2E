DROP TABLE TP_CLI_RCCMES;
DROP TABLE TP_BASE_CLI_RCCMES;
DROP TABLE TP_BASE_CLI_ENT_MAXSALDO;
DROP TABLE TP_CLI_ENTIDAD;

--CLIENTE BANCARIZADO, BASE PARA CALCULAR CUANTAS ENTIDADES TIENE POR MAXIMO SALDO
CREATE TABLE TP_BASE_CLI_RCCMES AS 
SELECT FLG_PRODUCTO,
       COD_ENTIDAD, 
       COD_CLIENTE_SBS, 
       SUM(a.MTO_SALDO) AS MTO_SALDO
 FROM SBS_FACT_SALDO a, SBS_ODS_PRODUCTO b
  WHERE  a.COD_SUBPRODUCTO = b.COD_SUBPRODUCTO
   AND A.COD_PERIODO = 201601                               --PARAMETRIZAR
   AND B.FLG_PRODUCTO IN ('SALDO','LINEA', 'INDIRECTO')     --PARAMETRIZAR
GROUP BY FLG_PRODUCTO,COD_ENTIDAD, COD_CLIENTE_SBS;


CREATE TABLE TP_BASE_CLI_ENT_MAXSALDO AS
SELECT  COD_CLIENTE_SBS,
        CASE WHEN SALD>0 THEN SALD
             WHEN LIN>0   THEN LIN
             WHEN IND>0  THEN IND
        END AS MAX_MTO_SALDO        
FROM (
SELECT COD_CLIENTE_SBS, 
       MAX(CASE WHEN FLG_PRODUCTO = 'SALDO'     THEN MTO_SALDO ELSE 0 END) AS SALD, --PARAMETRIZAR
       MAX(CASE WHEN FLG_PRODUCTO = 'LINEA'     THEN MTO_SALDO ELSE 0 END) AS LIN, --PARAMETRIZAR
       MAX(CASE WHEN FLG_PRODUCTO = 'INDIRECTO' THEN MTO_SALDO ELSE 0 END) AS IND
FROM TP_BASE_CLI_RCCMES
GROUP BY COD_CLIENTE_SBS
) AS S;


--CLIENTE BANCARIZADO, ENTIDAD CON MAYOR SALDO Y CANTIDAD DE ENTIDADES ENDEUDADO
CREATE TABLE TP_CLI_ENTIDAD AS 
SELECT T.COD_CLIENTE_SBS, T.COD_ENTIDAD, Z.TIP_ENTIDAD
FROM
(SELECT X.COD_CLIENTE_SBS, MIN(X.COD_ENTIDAD) AS COD_ENTIDAD
FROM TP_BASE_CLI_RCCMES X
LEFT OUTER JOIN TP_BASE_CLI_ENT_MAXSALDO Y
ON X.COD_CLIENTE_SBS = Y.COD_CLIENTE_SBS
AND X.MTO_SALDO = Y.MAX_MTO_SALDO
GROUP BY X.COD_CLIENTE_SBS) AS T 
LEFT OUTER JOIN sbs_dim_entidad Z
ON T.COD_ENTIDAD = Z.COD_ENTIDAD
;

------------------------------------------------------------------------------
--CLIENTE BANCARIZADO, LOS QUE TIENEN SALDO, LINEA O DEUDA INDIRECTA
----------------------------------------------------------------------------
CREATE TABLE TP_CLI_RCCMES AS
SELECT DISTINCT A.COD_CLIENTE_SBS
FROM SBS_FACT_SALDO A JOIN SBS_DIM_CLIENTE B ON A.COD_CLIENTE_SBS = B.COD_CLIENTE_SBS
WHERE 
CAST (B.COD_PERIODO_ULT AS INTEGER)BETWEEN 201503 AND 201512 --Periodo de 10 meses anteriores al presente
OR CAST (B.COD_PERIODO_ULT AS INTEGER)= 201412  --1er DIC previo al peridodo mencionado
OR CAST (B.COD_PERIODO_ULT AS INTEGER) = 201312 --2do DIC previo al peridodo mencionado
order by COD_CLIENTE_SBS
;
------------------------------------------------------------------------
--CALCULO DE CONTEOS Y SALDOS POR CLIENTE Y TIPO DE SALDO / LINEA
----------------------------------------------------------------------------
DROP TABLE TP_CONT_SALDOS_CLIENTE;

CREATE TABLE TP_CONT_SALDOS_CLIENTE AS
select 
SALDO.COD_CLIENTE_SBS,
COUNT( DISTINCT(CASE WHEN UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN COD_ENTIDAD ELSE NULL end)) AS CNT_ENTIDAD,
COUNT( DISTINCT(CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' then COD_ENTIDAD ELSE NULL end) ) AS CNT_ENTIDAD_SALDOTC,
COUNT( DISTINCT(CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD' AND UPPER(PROD.FLG_PRODUCTO)='LINEA' then COD_ENTIDAD ELSE NULL end) ) AS CNT_ENTIDAD_LINEATC,
COUNT( DISTINCT(CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'PTMO' AND  UPPER(PROD.FLG_PRODUCTO) = 'SALDO' then COD_ENTIDAD ELSE NULL end) ) AS CNT_ENTIDAD_PP,
COUNT( DISTINCT(CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND  UPPER(PROD.FLG_PRODUCTO) = 'SALDO' then COD_ENTIDAD ELSE NULL end) ) AS CNT_ENTIDAD_PMM,
COUNT( DISTINCT(CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND  UPPER(PROD.FLG_PRODUCTO) = 'LINEA' then COD_ENTIDAD ELSE NULL end) ) AS CNT_ENTIDAD_LINEA_PMM,
COUNT( DISTINCT(CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'HIPO' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' then COD_ENTIDAD ELSE NULL end) ) AS CNT_ENTIDAD_HIP,
SUM( CASE WHEN UPPER(PROD.FLG_PRODUCTO) = 'SALDO'  THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO,
SUM( CASE WHEN UPPER(PROD.FLG_PRODUCTO) <> 'SALDO'  THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_INDIRECTO,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'C' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD'     AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_TC,
SUM( CASE WHEN UPPER(SALDO.COD_SUBPRODUCTO) = 'PTMLDI'     AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_LD,
SUM( CASE WHEN UPPER(SALDO.COD_SUBPRODUCTO) = 'PTMVEH'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_VEH,
SUM( CASE WHEN UPPER(SALDO.COD_SUBPRODUCTO) = 'DEFETC'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_TC_DEF,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD'     AND UPPER(PROD.FLG_PRODUCTO)='LINEA' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_LINEATC,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'CMED'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_MED,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'CPEQ'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_PEQ,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'CMIC'  AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_MICRO,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND UPPER(PROD.FLG_PRODUCTO)='LINEA' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_LINEA_PMM,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'HIPO'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_HIP,
SUM( CASE WHEN UPPER(SALDO.COD_SUBPRODUCTO) = 'HIPMIV'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_HIP_MIV,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'E'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_EMP,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'E'    AND UPPER(PROD.FLG_PRODUCTO)='LINEA' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_LINEA_EMP,
SUM( CASE WHEN UPPER(SALDO.COD_SITCREDITO) = '4' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_REFINANCIADO,
SUM( CASE WHEN UPPER(SALDO.COD_SITCREDITO) = '6'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_JUDICIAL,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'CSTG'   AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CASTIGO,
--FINANCIERA EFECTIVA 237
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'C' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_PROP,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD'     AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_TC_PROP,
SUM( CASE WHEN UPPER(SALDO.COD_SUBPRODUCTO) = 'PTMLDI'     AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_LD_PROP,
SUM( CASE WHEN UPPER(SALDO.COD_SUBPRODUCTO) = 'PTMVEH'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_VEH_PROP,
SUM( CASE WHEN UPPER(SALDO.COD_SUBPRODUCTO) = 'DEFETC'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_TC_DEF_PROP,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD'     AND UPPER(PROD.FLG_PRODUCTO)='LINEA' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_LINEA_TC_PROP,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_PMM_PROP,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND UPPER(PROD.FLG_PRODUCTO)='LINEA' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_LINEA_PMM_PROP,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'HIPO'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_HIP_PROP,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'E'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_EMP_PROP,
SUM( CASE WHEN UPPER(SALDO.COD_SITCREDITO) = '4' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_REFINANCIADO_PROP,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'CSTG'   AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CASTIGO_PROP,
SUM( CASE WHEN UPPER(SALDO.COD_SITCREDITO) = '6'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_JUDICIAL_PROP,
0.05*SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) + 
0.05*0.2*(SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD' AND UPPER(PROD.FLG_PRODUCTO)='LINEA' THEN SALDO.MTO_SALDO ELSE 0 END) - 
          SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END)) + 
0.04*(SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'C' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) - 
      SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END)) + 
0.04*(SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END)) + 
0.01*SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'HIPO' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) MTO_CUOTA_MES
FROM 
    SBS_FACT_SALDO SALDO 
    LEFT OUTER JOIN SBS_ODS_PRODUCTO PROD ON SALDO.COD_SUBPRODUCTO = PROD.COD_SUBPRODUCTO
WHERE SALDO.COD_PERIODO =  201601 --MES A PROCESAR
AND MTO_SALDO > 0
GROUP BY SALDO.COD_CLIENTE_SBS;

----------------------------------------------------------------------------
--CALCULO DE CONTEOS MAXIMOS DE CADA ENTIDAD POR TIPO DE SALDO / LINEA
----------------------------------------------------------------------------
DROP TABLE  TP_BASE_SUM_ENTIDAD_CLIENTE;
DROP TABLE TP_BASE_RANK_ENTIDAD_CLIENTE;
DROP TABLE TP_MAX_ENTIDAD_CLIENTE;


CREATE TABLE TP_BASE_SUM_ENTIDAD_CLIENTE AS
SELECT
SALDO.COD_CLIENTE_SBS, 
COD_ENTIDAD,
SUM( (CASE WHEN UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 end)) AS MAX_SALDO_ENTIDAD,
SUM( (CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 end) ) AS MAX_SALDO_SALDOTC,
SUM( (CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD' AND UPPER(PROD.FLG_PRODUCTO)='LINEA' THEN SALDO.MTO_SALDO ELSE 0 end) ) AS MAX_SALDO_LINDTC,
SUM( (CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'PTMO' AND  UPPER(PROD.FLG_PRODUCTO) = 'SALDO' THEN SALDO.MTO_SALDO ELSE 0 end) ) AS MAX_SALDO_PTMO,
SUM( (CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND  UPPER(PROD.FLG_PRODUCTO) = 'SALDO' THEN SALDO.MTO_SALDO ELSE 0 end) ) AS MAX_SALDO_PSALDO,
SUM( (CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND  UPPER(PROD.FLG_PRODUCTO) = 'LINEA' THEN SALDO.MTO_SALDO ELSE 0 end) ) AS MAX_LINEA_PSALDO,
SUM( (CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'HIPO' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 end) ) AS MAX_SALDO_HIPOT,
SUM( (CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD' AND UPPER(PROD.FLG_PRODUCTO)='LINEA' THEN SALDO.MTO_SALDO ELSE 0 end)- 
     (CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'TCRD' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 end)
    ) AS MAX_SALDO_LINEATC
FROM 
    SBS_FACT_SALDO SALDO 
    LEFT OUTER JOIN SBS_ODS_PRODUCTO PROD ON SALDO.COD_SUBPRODUCTO = PROD.COD_SUBPRODUCTO
WHERE SALDO.COD_PERIODO =  201601 --MES A PROCESAR
AND MTO_SALDO > 0
GROUP BY SALDO.COD_CLIENTE_SBS, COD_ENTIDAD;


CREATE TABLE TP_BASE_RANK_ENTIDAD_CLIENTE AS
SELECT
COD_CLIENTE_SBS,
cod_entidad,
(CASE WHEN MAX_SALDO_ENTIDAD > 0 THEN 
DENSE_RANK() OVER (PARTITION BY COD_CLIENTE_SBS ORDER BY MAX_SALDO_ENTIDAD DESC) ELSE 0 END ) AS MAX_SALDO_ENTIDAD,
(CASE WHEN MAX_SALDO_SALDOTC > 0 THEN 
DENSE_RANK() OVER (PARTITION BY COD_CLIENTE_SBS ORDER BY MAX_SALDO_SALDOTC DESC) ELSE 0 END ) AS MAX_SALDO_SALDOTC,
(CASE WHEN MAX_SALDO_LINDTC > 0 THEN 
DENSE_RANK() OVER (PARTITION BY COD_CLIENTE_SBS ORDER BY MAX_SALDO_LINDTC DESC) ELSE 0 END ) AS MAX_SALDO_LINDTC,
(CASE WHEN MAX_SALDO_PTMO > 0 THEN 
DENSE_RANK() OVER (PARTITION BY COD_CLIENTE_SBS ORDER BY MAX_SALDO_PTMO DESC) ELSE 0 END ) AS MAX_SALDO_PTMO,
(CASE WHEN MAX_SALDO_PSALDO > 0 THEN 
DENSE_RANK() OVER (PARTITION BY COD_CLIENTE_SBS ORDER BY MAX_SALDO_PSALDO DESC) ELSE 0 END ) AS MAX_SALDO_PSALDO,
(CASE WHEN MAX_LINEA_PSALDO > 0 THEN 
DENSE_RANK() OVER (PARTITION BY COD_CLIENTE_SBS ORDER BY MAX_LINEA_PSALDO DESC) ELSE 0 END ) AS MAX_LINEA_PSALDO,
(CASE WHEN MAX_SALDO_HIPOT > 0 THEN 
DENSE_RANK() OVER (PARTITION BY COD_CLIENTE_SBS ORDER BY MAX_SALDO_HIPOT DESC) ELSE 0 END ) AS MAX_SALDO_HIPOT,
(CASE WHEN MAX_SALDO_LINEATC > 0 THEN 
DENSE_RANK() OVER (PARTITION BY COD_CLIENTE_SBS ORDER BY MAX_SALDO_LINEATC DESC) ELSE 0 END ) AS MAX_SALDO_LINEATC
FROM TP_BASE_SUM_ENTIDAD_CLIENTE;


CREATE TABLE TP_MAX_ENTIDAD_CLIENTE AS
SELECT 
COD_CLIENTE_SBS,
MAX(CASE WHEN MAX_SALDO_ENTIDAD = 1 THEN COD_ENTIDAD ELSE NULL END) AS COD_ENTIDAD_PRINC ,
MAX(CASE WHEN MAX_SALDO_SALDOTC = 1 THEN COD_ENTIDAD ELSE NULL END) AS COD_ENTIDAD_PRINC_SALDO_TC ,
MAX(CASE WHEN MAX_SALDO_LINDTC = 1 THEN COD_ENTIDAD ELSE NULL END) AS COD_ENTIDAD_PRINC_LINEA_TC ,
MAX(CASE WHEN MAX_SALDO_PTMO = 1 THEN COD_ENTIDAD ELSE NULL END) AS COD_ENTIDAD_PRINC_PP  ,
MAX(CASE WHEN MAX_SALDO_PSALDO = 1 THEN COD_ENTIDAD ELSE NULL END) AS COD_ENTIDAD_PRINC_PMM  ,
MAX(CASE WHEN MAX_LINEA_PSALDO = 1 THEN COD_ENTIDAD ELSE NULL END) AS COD_ENTIDAD_PRINC_LINEA_PMM ,
MAX(CASE WHEN MAX_SALDO_HIPOT = 1 THEN COD_ENTIDAD ELSE NULL END) AS COD_ENTIDAD_PRINC_HIP ,
MAX(CASE WHEN MAX_SALDO_LINEATC = 1 THEN COD_ENTIDAD ELSE NULL END) AS COD_ENTIDAD_PRINC_TC_DEF
FROM TP_BASE_RANK_ENTIDAD_CLIENTE X
WHERE  not(MAX_SALDO_ENTIDAD<>1 AND MAX_SALDO_SALDOTC<>1 AND MAX_SALDO_LINDTC<>1 AND MAX_SALDO_PTMO<>1 AND MAX_SALDO_PSALDO<>1
AND MAX_LINEA_PSALDO<>1 AND MAX_SALDO_HIPOT<>1 AND MAX_SALDO_LINEATC<>1)
GROUP BY COD_CLIENTE_SBS;


--------------------------------------------------------
--CALCULO DE SALDOS SIST FINANCIERO Y CLIENTE A 24 M
--------------------------------------------------------
DROP TABLE TP_CLI_SALDO_24M;

CREATE TABLE TP_CLI_SALDO_24M AS 
SELECT
SALDO.COD_CLIENTE_SBS,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'C' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_24M,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_PMM_24M,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND UPPER(PROD.FLG_PRODUCTO)='LINEA' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_LINEA_PMM_24M,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'HIPO'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_HIP_24M,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'E'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_EMP_24M,
--FINANCIERA EFECTIVA 237
SUM( CASE WHEN UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' AND COD_PERIODO = 201601 --MES DEL PROCESO
        THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_PROP,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'C' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_CONSUMO_PROP_24M,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_PMM_PROP_24M,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'P' AND UPPER(PROD.FLG_PRODUCTO)='LINEA' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_LINEA_PMM_PROP_24M,
SUM( CASE WHEN UPPER(PROD.COD_PRODUCTO) = 'HIPO'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_HIP_PROP_24M,
SUM( CASE WHEN UPPER(PROD.COD_FAMPRODUCTO) = 'E'    AND UPPER(PROD.FLG_PRODUCTO)='SALDO' AND SALDO.COD_ENTIDAD = '237' THEN SALDO.MTO_SALDO ELSE 0 END) AS MTO_SALDO_EMP_PROP_24M
FROM 
    SBS_FACT_SALDO SALDO 
    LEFT OUTER JOIN SBS_ODS_PRODUCTO PROD ON SALDO.COD_SUBPRODUCTO = PROD.COD_SUBPRODUCTO
WHERE SALDO.COD_PERIODO >= 201401     --24 MESES ANTERIORES AL MES A PROCESAR
AND MTO_SALDO > 0
GROUP BY SALDO.COD_CLIENTE_SBS;

---------------------------------------------
-- CARGA MENSUAL DE FACT CLIENTE
----------------------------------------------

INSERT INTO SBS_FACT_CLIENTE
(
COD_PERIODO,
COD_CLIENTE_SBS, 
COD_CLIENTE_PROP, 
TIP_DOCUMENTO_PRIN, 
COD_DOCUMENTO_PRIN, 
TIP_PERSONA,
POR_DEUDA_TIPO0, 
POR_DEUDA_TIPO1,
POR_DEUDA_TIPO2,
POR_DEUDA_TIPO3,
POR_DEUDA_TIPO4,
TIP_CLASIFICACION,
TIP_SIT_BANCARIZACION,
TIP_ENTIDAD_PROP_MAX,
CNT_ENTIDAD,
CNT_ENTIDAD_SALDOTC,
CNT_ENTIDAD_LINEATC,
CNT_ENTIDAD_PP,
CNT_ENTIDAD_PMM,
CNT_ENTIDAD_LINEA_PMM,
CNT_ENTIDAD_HIP,
MTO_SALDO,
MTO_SALDO_INDIRECTO,
MTO_SALDO_CONSUMO,
MTO_SALDO_CONSUMO_TC,
MTO_SALDO_CONSUMO_LD,
MTO_SALDO_CONSUMO_VEH,
MTO_SALDO_CONSUMO_TC_DEF,
MTO_SALDO_LINEATC,
MTO_SALDO_MED,
MTO_SALDO_PEQ,
MTO_SALDO_MICRO,
MTO_SALDO_LINEA_PMM,
MTO_SALDO_HIP,
MTO_SALDO_HIP_MIV,
MTO_SALDO_EMP,
MTO_SALDO_LINEA_EMP,
MTO_SALDO_REFINANCIADO,
MTO_SALDO_CASTIGO,
MTO_SALDO_JUDICIAL,
MTO_SALDO_CONSUMO_PROP,
MTO_SALDO_CONSUMO_TC_PROP,
MTO_SALDO_CONSUMO_LD_PROP,
MTO_SALDO_CONSUMO_VEH_PROP,
MTO_SALDO_CONSUMO_TC_DEF_PROP,
MTO_SALDO_LINEA_TC_PROP,
MTO_SALDO_PMM_PROP,
MTO_SALDO_LINEA_PMM_PROP,
MTO_SALDO_HIP_PROP,
MTO_SALDO_REFINANCIADO_PROP,
MTO_SALDO_CASTIGO_PROP,
MTO_SALDO_JUDICIAL_PROP,
COD_ENTIDAD_PRINC,
COD_ENTIDAD_PRINC_LINEA_TC,
COD_ENTIDAD_PRINC_SALDO_TC,
COD_ENTIDAD_PRINC_PP,
COD_ENTIDAD_PRINC_PMM,
COD_ENTIDAD_PRINC_LINEA_PMM,
COD_ENTIDAD_PRINC_HIP,
COD_ENTIDAD_PRINC_TC_DEF,
MTO_CUOTA_MES,
MTO_INGRESO,
COD_SEGMENTO_PROP,
TIP_MUNDO_PMM,
TIP_MUNDO_CONSUMO,
TIP_MUNDO_HIP,
TIP_MUNDO_EMP,
COD_UBIGEO 
)
SELECT 
CLI.COD_PERIODO,
CLI.COD_CLIENTE_SBS,
0  AS COD_CLIENTE_PROP, --PROPORCIONADO POR EL CLIENTE
(CASE WHEN CLI.TIP_PERSONA = '1' THEN CLI.TIP_DOCUMENTO_IDENT ELSE CLI.TIP_DOCUMENTO_TRIB END) AS TIP_DOCUMENTO_PRIN,
(CASE WHEN CLI.TIP_PERSONA = '1' THEN CLI.COD_DNI  ELSE CLI.COD_RUC END) AS COD_DOCUMENTO_PRIN,
CLI.TIP_PERSONA, 
CLI.POR_SALDO_DEUDA_TIP0, 
CLI.POR_SALDO_DEUDA_TIP1,
CLI.POR_SALDO_DEUDA_TIP2,
CLI.POR_SALDO_DEUDA_TIP3,
CLI.POR_SALDO_DEUDA_TIP4,
CASE WHEN CLI.POR_SALDO_DEUDA_TIP4     >=0.05 THEN 'PERDIDA'               --PARAMETRIZAR
     WHEN CLI.POR_SALDO_DEUDA_TIP3     >=0.05 THEN 'DUDOSO'                --PARAMETRIZAR
     WHEN CLI.POR_SALDO_DEUDA_TIP2     >=0.05 THEN 'DEFICIENTE'            --PARAMETRIZAR
     WHEN CLI.POR_SALDO_DEUDA_TIP1     >=0.05 THEN 'CPP'                   --PARAMETRIZAR 
     WHEN CLI.POR_SALDO_DEUDA_TIP0     >=0.05 THEN 'NORMAL'                --PARAMETRIZAR
     ELSE 'SIN CLASIFICACION' END AS TIP_CLASIFICACION,
CASE WHEN CLIMES.COD_CLIENTE_SBS IS NOT NULL                                                        THEN 'BANCARIZADO'
     WHEN CLIMES.COD_CLIENTE_SBS IS NOT NULL AND DCLI.TIP_SITUACION_BANCARIZACION = 'RECURRENTE'    THEN 'RECURRENTE'
     WHEN CLIMES.COD_CLIENTE_SBS IS NOT NULL AND DCLI.TIP_SITUACION_BANCARIZACION = 'PERDIDO'       THEN 'RECUPERADO'
     WHEN CLIMES.COD_CLIENTE_SBS IS NOT NULL AND DCLI.TIP_SITUACION_BANCARIZACION = 'RECUPERADO'    THEN 'RECURRENTE'
     ELSE 'NO DEFINIDO' END AS TIP_SITUACION_BANCARIZACION,
CLIENT.TIP_ENTIDAD AS TIP_ENTIDAD_PROP_MAX,
SALDCLI.CNT_ENTIDAD, 
SALDCLI.CNT_ENTIDAD_SALDOTC,
SALDCLI.CNT_ENTIDAD_LINEATC,
SALDCLI.CNT_ENTIDAD_PP,
SALDCLI.CNT_ENTIDAD_PMM,
SALDCLI.CNT_ENTIDAD_LINEA_PMM,
SALDCLI.CNT_ENTIDAD_HIP,
SALDCLI.MTO_SALDO,
SALDCLI.MTO_SALDO_INDIRECTO,
SALDCLI.MTO_SALDO_CONSUMO,
SALDCLI.MTO_SALDO_CONSUMO_TC,
SALDCLI.MTO_SALDO_CONSUMO_LD,
SALDCLI.MTO_SALDO_CONSUMO_VEH,
SALDCLI.MTO_SALDO_CONSUMO_TC_DEF,
SALDCLI.MTO_SALDO_LINEATC,
SALDCLI.MTO_SALDO_MED,
SALDCLI.MTO_SALDO_PEQ,
SALDCLI.MTO_SALDO_MICRO,
SALDCLI.MTO_SALDO_LINEA_PMM,
SALDCLI.MTO_SALDO_HIP,
SALDCLI.MTO_SALDO_HIP_MIV,
SALDCLI.MTO_SALDO_EMP,
SALDCLI.MTO_SALDO_LINEA_EMP,
SALDCLI.MTO_SALDO_REFINANCIADO,
SALDCLI.MTO_SALDO_CASTIGO,
SALDCLI.MTO_SALDO_JUDICIAL,
SALDCLI.MTO_SALDO_CONSUMO_PROP,
SALDCLI.MTO_SALDO_CONSUMO_TC_PROP,
SALDCLI.MTO_SALDO_CONSUMO_LD_PROP,
SALDCLI.MTO_SALDO_CONSUMO_VEH_PROP,
SALDCLI.MTO_SALDO_CONSUMO_TC_DEF_PROP,
SALDCLI.MTO_SALDO_LINEA_TC_PROP,
SALDCLI.MTO_SALDO_PMM_PROP,
SALDCLI.MTO_SALDO_LINEA_PMM_PROP,
SALDCLI.MTO_SALDO_HIP_PROP,
SALDCLI.MTO_SALDO_REFINANCIADO_PROP,
SALDCLI.MTO_SALDO_CASTIGO_PROP,
SALDCLI.MTO_SALDO_JUDICIAL_PROP,
ENTCLI.COD_ENTIDAD_PRINC,
ENTCLI.COD_ENTIDAD_PRINC_LINEA_TC,
ENTCLI.COD_ENTIDAD_PRINC_SALDO_TC,
ENTCLI.COD_ENTIDAD_PRINC_PP,
ENTCLI.COD_ENTIDAD_PRINC_PMM, 
ENTCLI.COD_ENTIDAD_PRINC_LINEA_PMM,
ENTCLI.COD_ENTIDAD_PRINC_HIP,
ENTCLI.COD_ENTIDAD_PRINC_TC_DEF, 
SALDCLI.MTO_CUOTA_MES,
0 AS MTO_INGRESO,            --PENDIENTE TABLE CLIENTE
NULL AS COD_SEGMENTO_PROP,    --PENDIENTE TABLE CLIENTE
CASE WHEN SALDCLI.MTO_SALDO_PMM_PROP>0                                        THEN 'Cliente PMM'
     WHEN SALDCLI.MTO_SALDO_CONSUMO_PROP>0 AND CLI24M.MTO_SALDO_PMM_24M>0     THEN 'Cliente Consumo con Saldo PMM en SF'
     WHEN CLI24M.MTO_SALDO_PMM_PROP_24M>0 AND CLI24M.MTO_SALDO_PMM_24M>0          THEN 'Ex Cliente PMM con Saldo PMM en SF'
     WHEN CLI24M.MTO_SALDO_PMM_24M>0                                             THEN 'No Cliente PMM con Saldo PMM en SF'
END AS TIP_MUNDO_PMM,
CASE WHEN SALDCLI.MTO_SALDO_CONSUMO_PROP > 0                                    THEN 'Cliente Consumo'
     WHEN CLI24M.MTO_SALDO_PROP         > 0 AND CLI24M.MTO_SALDO_CONSUMO_24M>0 THEN 'Cliente Consumo con Saldo Consumo en SF'
     WHEN CLI24M.MTO_SALDO_CONSUMO_PROP_24M>0 AND CLI24M.MTO_SALDO_CONSUMO_24M>0  THEN 'Ex Cliente Consumo con Saldo Consumo en SF'
     WHEN CLI24M.MTO_SALDO_CONSUMO_24M>0                                          THEN 'No Cliente Consumo con Saldo Consumo en SF'
END AS TIP_MUNDO_CONSUMO ,
CASE WHEN SALDCLI.MTO_SALDO_HIP_PROP > 0                                        THEN 'Cliente Hipotecario'
     WHEN CLI24M.MTO_SALDO_PROP         > 0 AND CLI24M.MTO_SALDO_HIP_24M>0     THEN 'Otros Productos son Saldo Hipotecario en SF'
     WHEN CLI24M.MTO_SALDO_HIP_PROP_24M>0 AND CLI24M.MTO_SALDO_HIP_24M>0          THEN 'Ex Cliente Hipotecario con Saldo Hipotecario en SF'
     WHEN CLI24M.MTO_SALDO_HIP_24M >0                                             THEN 'No Cliente Hipotecario con Saldo Hipotecario en SF'
END AS TIP_MUNDO_HIPOTECARIO ,
CASE WHEN SALDCLI.MTO_SALDO_EMP_PROP > 0                                        THEN 'Cliente Empresas'
     WHEN CLI24M.MTO_SALDO_PROP    > 0 AND CLI24M.MTO_SALDO_EMP_24M>0     THEN 'Otros Productos son Saldo Empresas en SF'
     WHEN CLI24M.MTO_SALDO_EMP_PROP_24M>0 AND CLI24M.MTO_SALDO_EMP_24M>0          THEN 'Ex Cliente Empresas con Saldo Empresas en SF'
     WHEN CLI24M.MTO_SALDO_EMP_24M>0                                              THEN 'No Cliente Empresas con Saldo Empresas en SF'
END AS TIP_MUNDO_EMP ,
'.' AS COD_UBIGEO --PENDIENTE TABLE CLIENTE*/
FROM SBS_ODS_CLIENTE CLI
   LEFT OUTER JOIN TP_CLI_RCCMES            CLIMES   ON CLI.COD_CLIENTE_SBS = CLIMES.COD_CLIENTE_SBS
   LEFT OUTER JOIN SBS_DIM_CLIENTE          DCLI     ON DCLI.COD_CLIENTE_SBS = CLIMES.COD_CLIENTE_SBS 
   LEFT OUTER JOIN TP_CLI_ENTIDAD           CLIENT   ON CLI.COD_CLIENTE_SBS = CLIENT.COD_CLIENTE_SBS
   LEFT OUTER JOIN TP_CONT_SALDOS_CLIENTE   SALDCLI  ON CLI.COD_CLIENTE_SBS = SALDCLI.COD_CLIENTE_SBS
   LEFT OUTER JOIN TP_MAX_ENTIDAD_CLIENTE   ENTCLI   ON CLI.COD_CLIENTE_SBS = ENTCLI.COD_CLIENTE_SBS
   LEFT OUTER JOIN TP_CLI_SALDO_24M         CLI24M   ON CLI.COD_CLIENTE_SBS = CLI24M.COD_CLIENTE_SBS
;